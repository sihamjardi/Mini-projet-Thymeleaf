<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üìä Statistiques Restaurant</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/styles.css" th:href="@{/css/styles.css}"/>
    <link rel="stylesheet" href="/css/dashboard.css" th:href="@{/css/dashboard.css}"/>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .stats-dashboard { max-width: 1400px; margin: 0 auto; }
        .stat-card-modern { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .stat-card-modern::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end)); }
        .stat-card-modern:hover { transform: translateY(-5px); box-shadow: 0 15px 50px rgba(0,0,0,0.15); }
        .stat-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.9; }
        .stat-value { font-size: 36px; font-weight: 700; color: #1a202c; margin: 8px 0; }
        .stat-label { font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .chart-container { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .date-selector { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .btn-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; font-weight: 600; padding: 12px 24px; border-radius: 10px; transition: all 0.3s ease; }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); color: white; }
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .grid-charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; }
        @media (max-width: 768px) { .grid-cards, .grid-charts { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="stats-dashboard">
    <div th:replace="~{fragments/nav :: navigation(page=${page})}"></div>

    <!-- Date Selector -->
    <div class="date-selector">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <h2 class="m-0">üìä Dashboard Statistiques</h2>
            <form th:action="@{/reservations/stats}" method="get" class="d-flex gap-2 align-items-center">
                <input type="date" name="date" class="form-control" th:value="${#temporals.format(date, 'yyyy-MM-dd')}" style="max-width: 200px;"/>
                <button type="submit" class="btn-gradient">üîÑ Actualiser</button>
                <a class="btn btn-secondary" href="#" onclick="history.back();return false;">‚Üê Retour</a>
            </form>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid-cards">
        <div class="stat-card-modern" style="--gradient-start: #3b82f6; --gradient-end: #1d4ed8;">
            <div class="stat-icon">üë•</div>
            <div class="stat-value" th:text="${totalClients}">0</div>
            <div class="stat-label">Total Clients</div>
        </div>

        <div class="stat-card-modern" style="--gradient-start: #10b981; --gradient-end: #047857;">
            <div class="stat-icon">ü™ë</div>
            <div class="stat-value" th:text="${totalTables}">0</div>
            <div class="stat-label">Total Tables</div>
        </div>

        <div class="stat-card-modern" style="--gradient-start: #8b5cf6; --gradient-end: #6d28d9;">
            <div class="stat-icon">üìã</div>
            <div class="stat-value" th:text="${totalReservations}">0</div>
            <div class="stat-label">R√©servations du jour</div>
        </div>

        <div class="stat-card-modern" style="--gradient-start: #f59e0b; --gradient-end: #d97706;">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value" th:text="${confirmed}">0</div>
            <div class="stat-label">Confirm√©es</div>
        </div>

        <div class="stat-card-modern" style="--gradient-start: #ef4444; --gradient-end: #dc2626;">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-value" th:text="${cancelled}">0</div>
            <div class="stat-label">Annul√©es</div>
        </div>

        <div class="stat-card-modern">
            <div class="stat-icon">üåÖ</div>
            <div class="stat-value" th:text="${#numbers.formatDecimal(matin,1,1)}">0</div>
            <div class="stat-label">Taux occupation matin (%)</div>
        </div>

        <div class="stat-card-modern">
            <div class="stat-icon">üåá</div>
            <div class="stat-value" th:text="${#numbers.formatDecimal(soir,1,1)}">0</div>
            <div class="stat-label">Taux occupation soir (%)</div>
        </div>

        <div class="stat-card-modern">
            <div class="stat-icon">üè†</div>
            <div class="stat-value" th:text="${#numbers.formatDecimal(tauxGlobal,1,1)}">0</div>
            <div class="stat-label">Taux occupation global (%)</div>
        </div>

        <div class="stat-card-modern">
            <div class="stat-icon">üö´</div>
            <div class="stat-value" th:text="${#numbers.formatDecimal(noShow,1,1)}">0</div>
            <div class="stat-label">Taux No-Show (%)</div>
        </div>

    </div>


    <!-- Charts Grid -->
    <div class="grid-charts">
        <div class="chart-container">
            <h4 class="mb-4">Taux d'occupation par service</h4>
            <canvas id="occupancyDoughnut"></canvas>
        </div>

        <div class="chart-container">
            <h4 class="mb-4">Si√®ges r√©serv√©s par service</h4>
            <canvas id="seatsBarChart"></canvas>
        </div>

        <div class="chart-container">
            <h4 class="mb-4">√âvolution du taux d'occupation</h4>
            <canvas id="occupancyLineChart"></canvas>
        </div>

        <div class="chart-container">
            <h4 class="mb-4">R√©partition par statut</h4>
            <canvas id="statusPieChart"></canvas>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const matinRate = /*[[${matin}]]*/ 0;
    const soirRate = /*[[${soir}]]*/ 0;
    const noShowRate = /*[[${noShow}]]*/ 0;

    const matinReserved = /*[[${matinReserved}]]*/ 0;
    const soirReserved = /*[[${soirReserved}]]*/ 0;
    const totalSeats = /*[[${totalSeats}]]*/ 0; // Ajouter le total de si√®ges disponibles

    const totalConfirmed = /*[[${confirmed}]]*/ 0;
    const totalCancelled = /*[[${cancelled}]]*/ 0;
    const totalReservations = /*[[${totalReservations}]]*/ 0;

    const ChartColors = {
      blue: 'rgba(59, 130, 246, 0.8)',
      green: 'rgba(16, 185, 129, 0.8)',
      purple: 'rgba(139, 92, 246, 0.8)',
      orange: 'rgba(245, 158, 11, 0.8)',
      red: 'rgba(239, 68, 68, 0.8)',
      pink: 'rgba(236, 72, 153, 0.8)',
      gray: '#d1d5db'
    };

    const pendingCount = Math.max(totalReservations - totalConfirmed - totalCancelled, 0);
    const freeSeats = Math.max(totalSeats - (matinReserved + soirReserved), 0);

    // Doughnut Chart - Taux occupation par service (Matin / Soir / Libre)
    new Chart(document.getElementById('occupancyDoughnut'), {
      type: 'doughnut',
      data: {
        labels: ['Matin', 'Soir', 'Libre'],
        datasets: [{
          data: [matinReserved, soirReserved, freeSeats],
          backgroundColor: [ChartColors.blue, ChartColors.green, ChartColors.gray],
          borderColor: ['#fff','#fff','#fff'],
          borderWidth:3,
          hoverOffset:8
        }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:true,
        cutout:'60%',
        plugins: {
          legend: { position:'bottom' },
          tooltip: {
            callbacks: {
              label: function(ctx){
                const value = ctx.parsed || 0;
                const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                const percentage = total > 0 ? value/total*100 : 0;
                return ctx.label + ': ' + value + ' si√®ges (' + percentage.toFixed(1) + '%)';
              }
            }
          }
        }
      }
    });

    // Bar Chart - Si√®ges r√©serv√©s
    new Chart(document.getElementById('seatsBarChart'), {
      type: 'bar',
      data: {
        labels:['Matin','Soir'],
        datasets:[{
          label:'Si√®ges r√©serv√©s',
          data:[matinReserved, soirReserved],
          backgroundColor:[ChartColors.blue, ChartColors.green],
          borderRadius:10,
          borderSkipped:false
        }]
      },
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true } }
      }
    });

    // Line Chart - √âvolution taux occupation
    new Chart(document.getElementById('occupancyLineChart'), {
      type:'line',
      data:{
        labels:['Matin','Soir'],
        datasets:[{
          label:'Taux d\'occupation (%)',
          data:[matinRate.toFixed(1), soirRate.toFixed(1)],
          borderColor:ChartColors.purple,
          backgroundColor:'rgba(139,92,246,0.1)',
          borderWidth:3,
          fill:true,
          tension:0.4
        }]
      },
      options:{ responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
    });

    // Pie Chart - R√©partition par statut
    new Chart(document.getElementById('statusPieChart'), {
      type:'pie',
      data:{
        labels:['Confirm√©es','Annul√©es','En attente'],
        datasets:[{
          data:[totalConfirmed, totalCancelled, pendingCount],
          backgroundColor:[ChartColors.orange, ChartColors.red, ChartColors.purple],
          borderColor:['#fff','#fff','#fff'],
          borderWidth:3
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{ position:'bottom' },
          tooltip:{
            callbacks:{
              label: function(ctx){
                const label=ctx.label||'';
                const value=ctx.parsed||0;
                const total=ctx.dataset.data.reduce((a,b)=>a+b,0);
                const percentage= total > 0 ? (value/total*100).toFixed(1) : 0;
                return label+': '+value+' ('+percentage+'%)';
              }
            }
          }
        }
      }
    });
</script>


</body>
</html>
